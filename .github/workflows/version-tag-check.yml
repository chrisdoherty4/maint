name: Check version tag

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+-rc[0-9]+"
  workflow_call:

permissions:
  contents: read

jobs:
  compare-version:
    name: Compare tag to manifest version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Read tag and manifest versions
        id: versions
        env:
          TAG_VERSION: ${{ github.ref_name }}
        run: |
          MANIFEST_VERSION=$(
            python - <<'PY'
              import json
              import os
              import re
              from pathlib import Path

              tag = os.environ["TAG_VERSION"].removeprefix("v")
              manifest_version = json.loads(
                  Path("custom_components/maint/manifest.json").read_text()
              )["version"]

              def parse(version: str) -> tuple[str, bool]:
                  match = re.fullmatch(r"(?P<base>\d+\.\d+\.\d+)(?:-rc(?P<rc>\d+))?", version)
                  if not match:
                      raise SystemExit(f"Version '{version}' is not valid semver or rc")
                  return match.group("base"), match.group("rc") is not None

              tag_base, tag_is_rc = parse(tag)
              manifest_base, manifest_is_rc = parse(manifest_version)

              if tag_base != manifest_base:
                  raise SystemExit(f"Base version mismatch: tag '{tag_base}', manifest '{manifest_base}'")

              if tag_is_rc != manifest_is_rc:
                  flavor_tag = "release candidate" if tag_is_rc else "final release"
                  flavor_manifest = "release candidate" if manifest_is_rc else "final release"
                  raise SystemExit(f"Release flavor mismatch: tag is {flavor_tag}, manifest is {flavor_manifest}")

              print(manifest_version)
PY
          )
          echo "tag_version=${TAG_VERSION#v}" >> "$GITHUB_OUTPUT"
          echo "manifest_version=${MANIFEST_VERSION}" >> "$GITHUB_OUTPUT"
