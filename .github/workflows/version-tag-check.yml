name: Check version tag

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+-rc[0-9]+"
  workflow_call:

permissions:
  contents: read

jobs:
  compare-version:
    name: Check Manifest Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Read tag and manifest versions
        id: versions
        env:
          TAG_VERSION: ${{ github.ref_name }}
        run: |
          TAG="${TAG_VERSION#v}"
          MANIFEST_VERSION=$(python -c "from pathlib import Path; import json; print(json.loads(Path('custom_components/maint/manifest.json').read_text())['version'])")

          if ! [[ "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$ ]]; then
            echo "Tag '${TAG_VERSION}' is not a valid semver or rc format." >&2
            exit 1
          fi

          if ! [[ "$MANIFEST_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$ ]]; then
            echo "Manifest version '${MANIFEST_VERSION}' is not a valid semver or rc format." >&2
            exit 1
          fi

          TAG_BASE="${TAG%%-rc*}"
          MANIFEST_BASE="${MANIFEST_VERSION%%-rc*}"

          TAG_IS_RC=false
          MANIFEST_IS_RC=false
          [[ "$TAG" == *-rc* ]] && TAG_IS_RC=true
          [[ "$MANIFEST_VERSION" == *-rc* ]] && MANIFEST_IS_RC=true

          if [ "$TAG_BASE" != "$MANIFEST_BASE" ]; then
            echo "Base version mismatch: tag '${TAG_BASE}', manifest '${MANIFEST_BASE}'." >&2
            exit 1
          fi

          if [ "$TAG_IS_RC" != "$MANIFEST_IS_RC" ]; then
            FLAVOR_TAG=$([ "$TAG_IS_RC" = true ] && echo "release candidate" || echo "final release")
            FLAVOR_MANIFEST=$([ "$MANIFEST_IS_RC" = true ] && echo "release candidate" || echo "final release")
            echo "Release flavor mismatch: tag is ${FLAVOR_TAG}, manifest is ${FLAVOR_MANIFEST}." >&2
            exit 1
          fi

          echo "tag_version=${TAG}" >> "$GITHUB_OUTPUT"
          echo "manifest_version=${MANIFEST_VERSION}" >> "$GITHUB_OUTPUT"
