name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
      - "v[0-9]+.[0-9]+.[0-9]+-rc[0-9]+"

permissions:
  contents: write

jobs:
  lint:
    name: Lint
    uses: ./.github/workflows/lint.yml
    secrets: inherit

  validate:
    name: Validate
    uses: ./.github/workflows/validate.yml
    secrets: inherit

  publish:
    name: Publish GitHub release
    needs:
      - lint
      - validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: Generate release notes with changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          gh api "repos/${{ github.repository }}/releases/generate-notes" \
            -f tag_name="$TAG_NAME" \
            -f target_commitish="${{ github.sha }}" \
            --jq '.body' > /tmp/base_notes.md

          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$' | sed -n '2p')
          if [ -z "$PREVIOUS_TAG" ]; then
            FIRST_COMMIT=$(git rev-list --max-parents=0 "$TAG_NAME" | head -n 1)
            RANGE="${FIRST_COMMIT}..${TAG_NAME}"
            SINCE_LABEL="first commit"
          else
            RANGE="${PREVIOUS_TAG}..${TAG_NAME}"
            SINCE_LABEL="${PREVIOUS_TAG}"
          fi

          CHANGELOG=$(git log "${RANGE}" --pretty=format:'- %s (%h)')
          {
            cat /tmp/base_notes.md
            echo
            echo "## Changes since ${SINCE_LABEL}"
            if [ -z "$CHANGELOG" ]; then
              echo "- No commits found in range."
            else
              echo "$CHANGELOG"
            fi
          } > /tmp/release_notes.md

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          gh release view "$TAG_NAME" >/dev/null 2>&1 && exit 0
          gh release create "$TAG_NAME" --title "$TAG_NAME" --notes-file /tmp/release_notes.md --draft
